name: macos-package

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    env:
      GOFLAGS: -ldflags=-linkmode=external
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Install fyne CLI
        run: |
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"
          go install fyne.io/fyne/v2/cmd/fyne@v2.4.5
      - name: Import signing certificate
        if: ${{ secrets.APPLE_CERT_P12 != '' }}
        env:
          APPLE_CERT_P12: ${{ secrets.APPLE_CERT_P12 }}
          APPLE_CERT_P12_PASSWORD: ${{ secrets.APPLE_CERT_P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.APPLE_KEYCHAIN_PASSWORD }}
        run: |
          if [ -z "$KEYCHAIN_PASSWORD" ]; then
            KEYCHAIN_PASSWORD="build-keychain-pass"
          fi
          echo "$APPLE_CERT_P12" | base64 --decode > signing.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import signing.p12 -k build.keychain -P "$APPLE_CERT_P12_PASSWORD" -T /usr/bin/codesign
          security list-keychain -d user -s build.keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
      - name: Download modules
        run: go mod download
      - name: Run tests
        run: go test ./...
      - name: License check
        run: ./scripts/check-licenses.sh
      - name: Build helper
        run: |
          mkdir -p dist
          go build -o dist/flasher-helper ./cmd/flasher-helper
      - name: Package app
        run: |
          fyne package -os darwin -src ./cmd/flasher-gui -name "Netboot Flasher" -appID "com.netbootflasher.app" -icon assets/icon.png
          mkdir -p dist
          mv "Netboot Flasher.app" dist/
      - name: Codesign app + helper
        if: ${{ secrets.APPLE_CERT_P12 != '' && secrets.APPLE_CERT_ID != '' }}
        env:
          APPLE_CERT_ID: ${{ secrets.APPLE_CERT_ID }}
        run: |
          codesign --force --deep --options runtime --sign "$APPLE_CERT_ID" "dist/Netboot Flasher.app"
          codesign --force --options runtime --sign "$APPLE_CERT_ID" dist/flasher-helper
          codesign --verify --deep --strict --verbose=2 "dist/Netboot Flasher.app"
          codesign --verify --strict --verbose=2 dist/flasher-helper
      - name: Create DMG
        run: |
          hdiutil create -volname "Netboot Flasher" -srcfolder "dist/Netboot Flasher.app" -ov -format UDZO "dist/Netboot-Flasher.dmg"
      - name: Notarize DMG
        if: ${{ secrets.APPLE_ID != '' && secrets.APPLE_APP_PASSWORD != '' && secrets.APPLE_TEAM_ID != '' }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcrun notarytool submit "dist/Netboot-Flasher.dmg" --apple-id "$APPLE_ID" --password "$APPLE_APP_PASSWORD" --team-id "$APPLE_TEAM_ID" --wait
          xcrun stapler staple "dist/Netboot-Flasher.dmg"
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: netboot-flasher-macos
          path: |
            "dist/Netboot Flasher.app"
            dist/Netboot-Flasher.dmg
            dist/flasher-helper
